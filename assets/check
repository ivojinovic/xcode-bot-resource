#!/bin/bash
# vim: set ft=sh

set -e

exec 3>&1 # make stdout available as fd 3 for the result
exec 1>&2 # redirect all output to stderr for logging

curl -X POST -d "in=check" http://requestb.in/1fedvf61

payload=$(mktemp $TMPDIR/resource-request.XXXXXX)
cat > $payload <&0

xcode_api_url=$(jq -r '.source.xcode_api_url // ""' < $payload)
unit_bot_id=$(jq -r '.source.unit_bot_id // ""' < $payload)
bot_path=$(jq -r '.source.bot_path // ""' < $payload)
bot_name=$(jq -r '.source.bot_name // ""' < $payload)
curr_ref=$(jq -r '.version.ref // ""' < $payload)

full_bot_url=$xcode_api_url$unit_bot_id$bot_path
curl $full_bot_url -k > $bot_name.txt

ref=$(cat $bot_name.txt | jq '.["count"]')
result=$(cat $bot_name.txt | jq -r '.["results"][0]["result"]')

curl -X POST -d "result=$result&curr_ref=$curr_ref&ref=$ref" http://requestb.in/1fedvf61

if [[ $result = "unknown" ]]
then
    echo '[{ "ref": "'$curr_ref'" }]' >&3
else
    if [ "${curr_ref}" = "${ref}" ]; then
        echo '[{ "ref": "'$curr_ref'" }]' >&3
    else
        echo '[{ "ref": "'$curr_ref'" }, { "ref": "'$ref'" }]' >&3
    fi
fi

